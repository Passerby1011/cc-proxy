# Web Search & Web Fetch é›†æˆå‡çº§è®¡åˆ’

> æœ¬æ–‡æ¡£æè¿°äº†åœ¨ cc-proxy ä¸­é›†æˆ Firecrawl ä»¥å®ç° Anthropic Web Search å’Œ Web Fetch åŠŸèƒ½æ›¿ä»£çš„è¯¦ç»†è®¡åˆ’
> **æ›´æ–°æ—¥æœŸ**: 2026-01-09 (åŸºäºæŠ€æœ¯è®¨è®ºæ›´æ–°)
> **é…å¥—æ–‡æ¡£**: [æŠ€æœ¯èµ„æ–™æ–‡æ¡£](./web-search-fetch-integration-research.md)

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 ç›®æ ‡

åœ¨ cc-proxy ä¸­é›†æˆ Firecrawl API,å®ç°å¯¹ Anthropic å®˜æ–¹ Web Search å’Œ Web Fetch åŠŸèƒ½çš„å®Œå…¨æ›¿ä»£,ä½¿å¾—ä¸æ”¯æŒè¿™ä¸¤ä¸ªåŠŸèƒ½çš„ä¸Šæ¸¸ APIä¹Ÿèƒ½é€šè¿‡ cc-proxy è·å¾—ç½‘ç»œæœç´¢å’Œå†…å®¹è·å–èƒ½åŠ›ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

1. **åŠŸèƒ½è¡¥é½**: ä¸ºä¸æ”¯æŒ web search/fetch çš„ API æä¾›å•†æä¾›è¿™äº›é«˜çº§åŠŸèƒ½
2. **æˆæœ¬ä¼˜åŒ–**: ä½¿ç”¨ Firecrawl æ›¿ä»£ Anthropic å®˜æ–¹æœåŠ¡,å¯èƒ½é™ä½ä½¿ç”¨æˆæœ¬
3. **çµæ´»æ§åˆ¶**: åœ¨ proxy å±‚é¢æ§åˆ¶æœç´¢å’ŒæŠ“å–è¡Œä¸º,ä¾¿äºå®¡è®¡å’Œé™åˆ¶
4. **é€æ˜æ¥å…¥**: å®¢æˆ·ç«¯(å¦‚ Claude Code)æ— éœ€ä»»ä½•ä¿®æ”¹,å®Œå…¨é€æ˜

### 1.3 å¯è¡Œæ€§è¯„ä¼°

**âœ… æŠ€æœ¯å¯è¡Œ**:
- Firecrawl æä¾›äº†å®Œæ•´çš„æœç´¢å’ŒæŠ“å–èƒ½åŠ›
- API å“åº”æ ¼å¼å¯ä»¥é€šè¿‡è½¬æ¢å±‚é€‚é… Anthropic æ ¼å¼
- deno-proxy å·²æœ‰å¤„ç† tool use çš„åŸºç¡€æ¶æ„

**âš ï¸ ä¸»è¦æŒ‘æˆ˜**:
1. å“åº”æ ¼å¼å·®å¼‚éœ€è¦è½¬æ¢å±‚é€‚é…
2. Anthropic çš„ `encrypted_content` éœ€è¦æ¨¡æ‹Ÿå®ç°(ä½¿ç”¨ä¸é€æ˜æ ‡è¯†ç¬¦)
3. æµå¼å“åº”éœ€è¦å¤„ç† Firecrawl çš„è°ƒç”¨å»¶è¿Ÿ
4. éœ€è¦åœ¨"ç®€å•è¿”å›æœç´¢ç»“æœ"å’Œ"ç”Ÿæˆæ™ºèƒ½å›ç­”"ä¹‹é—´åšæƒè¡¡

**ğŸ’° æˆæœ¬è€ƒé‡**:
- Anthropic Web Search: $10/1000æ¬¡ + tokenæˆæœ¬
- Firecrawl Search: 2 credits/10ç»“æœ + æŠ“å–æˆæœ¬
- æ··åˆæ¨¡å¼å¯èƒ½å¢åŠ ä¸Šæ¸¸ API token æˆæœ¬(å¦‚å¯ç”¨æ™ºèƒ½å›ç­”)
- éœ€è¦æ ¹æ®å®é™…ä½¿ç”¨è¯„ä¼°æˆæœ¬æ•ˆç›Š

### 1.4 å·¥ä½œæµç¨‹ç†è§£

**å…³é”®è®¤çŸ¥**: Anthropic Web Search æ˜¯ **Server-Side Tool**,å·¥ä½œæµç¨‹å¦‚ä¸‹:

```
å®¢æˆ·ç«¯è¯·æ±‚ â†’ Anthropic API â†’ Claude å†³å®šæœç´¢
  â†’ Anthropic æœåŠ¡å™¨æ‰§è¡Œæœç´¢ â†’ æœç´¢ç»“æœæ³¨å…¥ Claude ä¸Šä¸‹æ–‡
  â†’ Claude åŸºäºç»“æœç”Ÿæˆå›ç­” â†’ ä¸€æ¬¡æ€§è¿”å›(æœç´¢ç»“æœ + å›ç­”)
```

**cc-proxy çš„æŒ‘æˆ˜**:
- ä¸Šæ¸¸ APIä¸æ”¯æŒ server-side tool
- éœ€è¦åœ¨ä»£ç†å±‚æ‹¦æˆªå¹¶å®ç°æœç´¢é€»è¾‘
- æœ‰ä¸¤ç§ç­–ç•¥å¯é€‰:
  1. **ç®€å•æ¨¡å¼**: åªè¿”å›æœç´¢ç»“æœ(å¿«é€Ÿã€ç®€å•)
  2. **æ™ºèƒ½æ¨¡å¼**: è¿”å›æœç´¢ç»“æœ + åŸºäºç»“æœçš„å›ç­”(éœ€é¢å¤–çš„ä¸Šæ¸¸è°ƒç”¨)

### 1.5 å·¥ä½œæ¨¡å¼è®¾è®¡(æ¨èæ–¹æ¡ˆ)

åŸºäºæŠ€æœ¯è®¨è®º,æˆ‘ä»¬é‡‡ç”¨**å¯é…ç½®çš„å·¥ä½œæ¨¡å¼**,é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶:

| æ¨¡å¼ | æµç¨‹ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|---------|
| **ç®€å•æ¨¡å¼** (é»˜è®¤) | Firecrawl æœç´¢ â†’ ç›´æ¥è¿”å›æœç´¢ç»“æœ | å¿«é€Ÿã€ç®€å•ã€æˆæœ¬ä½ã€æ— äºŒæ¬¡è¯·æ±‚ | åªè¿”å›æœç´¢é“¾æ¥ | å¤§å¤šæ•°åœºæ™¯ |
| **æ™ºèƒ½æ¨¡å¼** (å¯é€‰) | Firecrawl æœç´¢ â†’ ä¸Šæ¸¸ API åˆ†æ â†’ è¿”å›ç»“æœ+æ™ºèƒ½å›ç­” | æä¾›æ·±åº¦åˆ†æå’Œæ€»ç»“ | éœ€äºŒæ¬¡è¯·æ±‚ã€å¢åŠ å»¶è¿Ÿå’Œæˆæœ¬ | éœ€è¦æ·±åº¦åˆ†æçš„åœºæ™¯ |

**æ ¸å¿ƒè®¾è®¡å†³ç­–**:

**é»˜è®¤ä½¿ç”¨ç®€å•æ¨¡å¼çš„ç†ç”±**:
1. âœ… **ç¬¦åˆ Anthropic åŸç”Ÿè¡Œä¸º**: Web Search æœ¬è´¨ä¸Šè¿”å›æœç´¢ç»“æœ,è€Œéæœç´¢å¼•æ“
2. âœ… **å®¢æˆ·ç«¯å·¥ä½œæµå®Œæ•´**: å®¢æˆ·ç«¯å¯ä»¥åŸºäºæœç´¢ç»“æœè‡ªä¸»å†³å®šæ˜¯å¦ä½¿ç”¨ Web Fetch æ·±å…¥äº†è§£
3. âœ… **é¿å…ä¸å¿…è¦çš„å¤æ‚æ€§**: ä¸éœ€è¦äºŒæ¬¡è¯·æ±‚,å‡å°‘å¤±è´¥ç‚¹
4. âœ… **é™ä½å»¶è¿Ÿå’Œæˆæœ¬**: ä¸€æ¬¡ Firecrawl è°ƒç”¨å³å¯,æ— ä¸Šæ¸¸ API token æ¶ˆè€—
5. âœ… **ä»£ç†èŒè´£æ¸…æ™°**: cc-proxy ä¸“æ³¨äºæ ¼å¼è½¬æ¢å’Œåè®®é€‚é…,ä¸åšå†…å®¹åŠ å·¥

**æ™ºèƒ½æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯**:
- éœ€è¦ LLM ç†è§£å’Œæ€»ç»“æœç´¢ç»“æœ
- è¿½æ±‚æè‡´çš„ç”¨æˆ·ä½“éªŒ(ç±»ä¼¼ Anthropic åŸç”Ÿå®Œæ•´å“åº”)
- å¯ä»¥æ¥å—é¢å¤–çš„å»¶è¿Ÿå’Œæˆæœ¬

**é…ç½®æ–¹å¼**:
```bash
# ç®€å•æ¨¡å¼(é»˜è®¤)
WEB_SEARCH_MODE=simple

# æ™ºèƒ½æ¨¡å¼(éœ€äºŒæ¬¡è¯·æ±‚)
WEB_SEARCH_MODE=smart
```

---

## äºŒã€æŠ€æœ¯æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

#### 2.1.1 ç®€å•æ¨¡å¼æ¶æ„ï¼ˆé»˜è®¤ï¼Œæ¨èï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Claude Code â”‚ (å®¢æˆ·ç«¯)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /v1/messages
       â”‚ {tools: [{type: "web_search_20250305"}]}
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         cc-proxy (deno-proxy)       â”‚
â”‚                                     â”‚
â”‚  1. æ£€æµ‹åˆ° web_search tool          â”‚
â”‚  2. æå–ç”¨æˆ·é—®é¢˜                    â”‚
â”‚  3. æ„å»ºæœç´¢æŸ¥è¯¢ï¼ˆç®€å•å¯å‘å¼ï¼‰      â”‚
â”‚     â†“                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  è°ƒç”¨ Firecrawl Search API  â”‚   â”‚
â”‚  â”‚  - query: æå–çš„å…³é”®è¯      â”‚   â”‚
â”‚  â”‚  - limit: 5                 â”‚   â”‚
â”‚  â”‚  - scrape: markdown         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚     â†“                               â”‚
â”‚  4. æ ¼å¼è½¬æ¢ï¼ˆFirecrawl â†’ Anthropicï¼‰â”‚
â”‚     - ç”Ÿæˆ encrypted_content       â”‚
â”‚     - æ„å»º web_search_tool_result  â”‚
â”‚  5. æµå¼è¿”å›æœç´¢ç»“æœ               â”‚
â”‚     - server_tool_use å—            â”‚
â”‚     - web_search_tool_result å—     â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Firecrawl   â”‚
â”‚     API      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å“åº”ç¤ºä¾‹ï¼š
{
  "content": [
    {
      "type": "server_tool_use",
      "name": "web_search",
      "input": {"query": "Firecrawl"}
    },
    {
      "type": "web_search_tool_result",
      "content": [
        {
          "url": "https://firecrawl.dev",
          "title": "Firecrawl",
          "encrypted_content": "..."
        }
      ]
    }
  ]
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… ä¸€æ¬¡ Firecrawl è°ƒç”¨
- âœ… ç›´æ¥è¿”å›æœç´¢ç»“æœ
- âœ… å®¢æˆ·ç«¯å¯è‡ªä¸»å†³å®šæ˜¯å¦ web fetch
- âœ… ç®€å•ã€å¿«é€Ÿã€ä½æˆæœ¬

#### 2.1.2 æ™ºèƒ½æ¨¡å¼æ¶æ„ï¼ˆå¯é€‰ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Claude Code â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /v1/messages
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         cc-proxy (deno-proxy)       â”‚
â”‚                                     â”‚
â”‚  1. æ£€æµ‹åˆ° web_search tool          â”‚
â”‚     â†“                               â”‚
â”‚  2. ç¬¬ä¸€æ¬¡ä¸Šæ¸¸è°ƒç”¨ï¼ˆå¯é€‰ï¼‰          â”‚
â”‚     æå–ç²¾ç¡®æœç´¢è¯                  â”‚
â”‚     â†“                               â”‚
â”‚  3. è°ƒç”¨ Firecrawl Search           â”‚
â”‚     â†“                               â”‚
â”‚  4. ç¬¬äºŒæ¬¡ä¸Šæ¸¸è°ƒç”¨                  â”‚
â”‚     - æ„å»ºå¢å¼ºä¸Šä¸‹æ–‡                â”‚
â”‚     - è®© LLM åˆ†ææœç´¢ç»“æœ           â”‚
â”‚     â†“                               â”‚
â”‚  5. è¿”å›ï¼šæœç´¢ç»“æœ + æ™ºèƒ½å›ç­”       â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚             â”‚
       â†“             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸Šæ¸¸ API    â”‚  â”‚  Firecrawl   â”‚
â”‚ (OpenAIç­‰)  â”‚  â”‚     API      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å“åº”ç¤ºä¾‹ï¼š
{
  "content": [
    {
      "type": "web_search_tool_result",
      "content": [...]  // æœç´¢ç»“æœ
    },
    {
      "type": "text",
      "text": "æ ¹æ®æœç´¢ç»“æœï¼ŒFirecrawl æ˜¯..."  // LLM åˆ†æ
    }
  ]
}
```

**ç‰¹ç‚¹**ï¼š
- âš ï¸ éœ€è¦ 1-2 æ¬¡ä¸Šæ¸¸ API è°ƒç”¨
- âœ… æä¾›æ™ºèƒ½åˆ†æå’Œæ€»ç»“
- âœ… æ›´æ¥è¿‘ Anthropic åŸç”Ÿä½“éªŒ
- âŒ å¢åŠ å»¶è¿Ÿå’Œæˆæœ¬

### 2.2 æ ¸å¿ƒæ¨¡å—è®¾è®¡

#### 2.2.1 Tool æ‹¦æˆªå™¨ (tool_interceptor.ts)

**æ¨¡å—èŒè´£**ï¼š
- æ£€æµ‹è¯·æ±‚ä¸­æ˜¯å¦åŒ…å« `web_search_20250305` æˆ– `web_fetch_20250910` tool
- æ ¹æ®é…ç½®é€‰æ‹©ç®€å•æ¨¡å¼æˆ–æ™ºèƒ½æ¨¡å¼è¿›è¡Œå¤„ç†
- æå–ç”¨æˆ·é—®é¢˜å¹¶ç”Ÿæˆæœç´¢æŸ¥è¯¢
- è°ƒç”¨ Firecrawl API è·å–ç»“æœ
- å°†ç»“æœè½¬æ¢ä¸º Anthropic æ ¼å¼å¹¶è¿”å›

**ç®€å•æ¨¡å¼å¤„ç†æµç¨‹**ï¼š
1. ä»è¯·æ±‚æ¶ˆæ¯ä¸­æå–ç”¨æˆ·é—®é¢˜
2. ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ç®€å•æå–å…³é”®è¯ï¼ˆç§»é™¤åœç”¨è¯å¦‚ "what is", "how", "why" ç­‰ï¼‰
3. è°ƒç”¨ Firecrawl Search APIï¼Œä¼ å…¥æŸ¥è¯¢è¯å’Œé™åˆ¶æ•°é‡
4. å°† Firecrawl å“åº”è½¬æ¢ä¸º Anthropic æ ¼å¼
5. æ„å»ºå¹¶è¿”å› Anthropic å“åº”ï¼ŒåŒ…å« `server_tool_use` å’Œ `web_search_tool_result` å—

**æ™ºèƒ½æ¨¡å¼å¤„ç†æµç¨‹**ï¼š
1. æ‰§è¡Œç®€å•æ¨¡å¼çš„æœç´¢æ­¥éª¤
2. æ„å»ºå¢å¼ºä¸Šä¸‹æ–‡ï¼Œå°†æœç´¢ç»“æœä½œä¸ºèƒŒæ™¯ä¿¡æ¯
3. è°ƒç”¨ç°åœ¨ç”¨çš„ä¸Šæ¸¸ APIè¿›è¡Œåˆ†æ
4. è¿”å›æœç´¢ç»“æœ + LLM æ™ºèƒ½åˆ†æ

**æ ¸å¿ƒæ–¹æ³•**ï¼š
- `shouldIntercept()`: æ£€æŸ¥è¯·æ±‚æ˜¯å¦éœ€è¦æ‹¦æˆª
- `handleSimpleMode()`: å¤„ç†ç®€å•æ¨¡å¼è¯·æ±‚
- `handleSmartMode()`: å¤„ç†æ™ºèƒ½æ¨¡å¼è¯·æ±‚
- `extractKeywords()`: ç®€å•å…³é”®è¯æå–ï¼Œé™åˆ¶é•¿åº¦ä¸º 200 å­—ç¬¦

#### 2.2.2 Firecrawl å®¢æˆ·ç«¯ (firecrawl_client.ts)

**æ¨¡å—èŒè´£**ï¼š
- å°è£… Firecrawl API è°ƒç”¨é€»è¾‘
- å¤„ç† API è®¤è¯å’Œè¯·æ±‚æ„å»º
- å®ç°é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- æ”¯æŒè¶…æ—¶æ§åˆ¶

**æ ¸å¿ƒæ¥å£**ï¼š
- `search()`: æ‰§è¡Œç½‘ç»œæœç´¢ï¼Œæ”¯æŒæŸ¥è¯¢è¯ã€ç»“æœæ•°é‡é™åˆ¶ã€ä½ç½®å‚æ•°ã€æŠ“å–é€‰é¡¹é…ç½®
- `scrape()`: æŠ“å–å•ä¸ª URL å†…å®¹ï¼Œæ”¯æŒæ ¼å¼é€‰æ‹©ï¼ˆmarkdown/htmlï¼‰ã€ä½ç½®è®¾ç½®
- `batchScrape()`: æ‰¹é‡æŠ“å–å¤šä¸ª URLï¼Œæ”¯æŒè½®è¯¢é—´éš”å’Œè¶…æ—¶é…ç½®

**å‚æ•°è¯´æ˜**ï¼š
- SearchParams: åŒ…å« queryï¼ˆæŸ¥è¯¢è¯ï¼‰ã€limitï¼ˆç»“æœæ•°é‡ï¼‰ã€locationï¼ˆåœ°ç†ä½ç½®ï¼‰ã€scrape_optionsï¼ˆæŠ“å–é€‰é¡¹ï¼Œå¦‚æ ¼å¼è¦æ±‚ï¼‰
- ScrapeParams: åŒ…å« urlã€formatsï¼ˆè¾“å‡ºæ ¼å¼ï¼‰ã€locationï¼ˆä½ç½®ä¿¡æ¯ï¼‰
- BatchScrapeParams: åŒ…å« urlsï¼ˆURL åˆ—è¡¨ï¼‰ã€formatsã€pollIntervalï¼ˆè½®è¯¢é—´éš”ï¼‰ã€waitTimeoutï¼ˆç­‰å¾…è¶…æ—¶ï¼‰

**é”™è¯¯å¤„ç†**ï¼š
- API å¯†é’¥éªŒè¯å¤±è´¥
- é€Ÿç‡é™åˆ¶ï¼ˆ429 é”™è¯¯ï¼‰
- ç½‘ç»œè¶…æ—¶
- æ— æ•ˆçš„è¯·æ±‚å‚æ•°
- æœåŠ¡ä¸å¯ç”¨ï¼ˆ5xx é”™è¯¯ï¼‰

#### 2.2.3 æ ¼å¼è½¬æ¢å™¨ (format_converter.ts)

**æ¨¡å—èŒè´£**ï¼š
- å°† Firecrawl çš„å“åº”æ ¼å¼è½¬æ¢ä¸º Anthropic çš„æ ‡å‡†æ ¼å¼
- ç”Ÿæˆ `encrypted_content` å’Œ `encrypted_index` æ ‡è¯†ç¬¦
- æ„å»ºå¼•ç”¨ä¿¡æ¯ï¼ˆcitationsï¼‰
- å¤„ç†ä¸åŒå†…å®¹ç±»å‹ï¼ˆæ–‡æœ¬ã€PDFï¼‰

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- `convertSearchResult()`: å°† Firecrawl æœç´¢ç»“æœè½¬æ¢ä¸º `web_search_tool_result` æ ¼å¼
  - éå† Firecrawl è¿”å›çš„æœç´¢ç»“æœåˆ—è¡¨
  - ä¸ºæ¯ä¸ªç»“æœç”Ÿæˆå”¯ä¸€çš„ `encrypted_content`ï¼ˆä½¿ç”¨ UUID + base64 ç¼–ç ï¼‰
  - æ„å»º `web_search_result` å¯¹è±¡ï¼ŒåŒ…å« urlã€titleã€encrypted_contentã€page_age

- `convertScrapeResult()`: å°† Firecrawl æŠ“å–ç»“æœè½¬æ¢ä¸º `web_fetch_tool_result` æ ¼å¼
  - æå– markdown æˆ– html å†…å®¹
  - æ„å»º document å—ç»“æ„
  - å¤„ç† PDF æ—¶ä½¿ç”¨ base64 ç¼–ç 
  - æ·»åŠ å…ƒæ•°æ®ï¼ˆtitleã€retrieved_at ç­‰ï¼‰

- `buildCitations()`: æ„å»ºå¼•ç”¨ä¿¡æ¯
  - ä»å†…å®¹ä¸­æå–è¢«å¼•ç”¨çš„æ–‡æœ¬ç‰‡æ®µ
  - ä¸ºæ¯ä¸ªå¼•ç”¨ç”Ÿæˆ `encrypted_index`
  - æ„å»º `web_search_result_location` æˆ– `char_location` å¯¹è±¡
  - åŒ…å« urlã€titleã€cited_text ç­‰ä¿¡æ¯

- `generateEncryptedContent()`: ç”ŸæˆåŠ å¯†å†…å®¹æ ‡è¯†
  - ä½¿ç”¨ crypto.randomUUID() ç”Ÿæˆå”¯ä¸€ ID
  - å°† IDã€URLã€å†…å®¹é¢„è§ˆæ‰“åŒ…ä¸º JSON
  - ä½¿ç”¨ btoa() è¿›è¡Œ base64 ç¼–ç 
  - è¿”å›ä¸é€æ˜æ ‡è¯†ç¬¦å­—ç¬¦ä¸²

**æ•°æ®ç»“æ„æ˜ å°„**ï¼š
- Firecrawl `data.web[]` â†’ Anthropic `web_search_result[]`
- Firecrawl `markdown/html` â†’ Anthropic `document.source.data`
- Firecrawl `title/url` â†’ Anthropic `title/url`
- ç”Ÿæˆçš„ UUID â†’ Anthropic `encrypted_content`

---

## ä¸‰ã€å®æ–½é˜¶æ®µ

### é˜¶æ®µ 1: åŸºç¡€è®¾æ–½å‡†å¤‡ (2-3 å¤©)

**ç›®æ ‡**: æ­å»º Firecrawl é›†æˆçš„åŸºç¡€æ¶æ„

#### ä»»åŠ¡æ¸…å•:

- [ ] **1.1 æ·»åŠ  Firecrawl ä¾èµ–**
  - åœ¨ `deno.json` ä¸­æ·»åŠ  Firecrawl ç›¸å…³ä¾èµ–
  - åˆ›å»º Firecrawl API é…ç½®(API Key ç­‰)
  - æ·»åŠ ç¯å¢ƒå˜é‡æ”¯æŒ

- [ ] **1.2 åˆ›å»ºæ ¸å¿ƒæ¨¡å—æ–‡ä»¶**
  - `deno-proxy/src/tools/tool_interceptor.ts`
  - `deno-proxy/src/tools/firecrawl_client.ts`
  - `deno-proxy/src/tools/format_converter.ts`
  - `deno-proxy/src/tools/types.ts` (ç±»å‹å®šä¹‰)

- [ ] **1.3 é…ç½®ç®¡ç†**
  - åœ¨ `config.ts` ä¸­æ·»åŠ  Firecrawl é…ç½®é¡¹
  - æ·»åŠ åŠŸèƒ½å¼€å…³(æ˜¯å¦å¯ç”¨ web search/fetch æ‹¦æˆª)

#### éªŒè¯æ ‡å‡†:
- Firecrawl API å¯ä»¥æˆåŠŸè°ƒç”¨
- åŸºç¡€æ¨¡å—ç»“æ„æ¸…æ™°,ç±»å‹å®šä¹‰å®Œæ•´
- é…ç½®å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡çµæ´»æ§åˆ¶

---

### é˜¶æ®µ 2: Web Search åŠŸèƒ½å®ç°ï¼ˆç®€å•æ¨¡å¼ï¼‰(2-3 å¤©)

**ç›®æ ‡**: å®ç° Web Search çš„åŸºç¡€æ‹¦æˆªå’Œæ ¼å¼è½¬æ¢ï¼ˆç®€å•æ¨¡å¼ï¼‰

#### ä»»åŠ¡æ¸…å•:

- [ ] **2.1 è¯·æ±‚æ‹¦æˆª**
  - åœ¨è¯·æ±‚å¤„ç†æµç¨‹ä¸­è¯†åˆ« `web_search_20250305` tool
  - æå– tool å®šä¹‰ä¸­çš„å‚æ•°(`max_uses`, `allowed_domains` ç­‰)
  - æå–ç”¨æˆ·é—®é¢˜æ–‡æœ¬

- [ ] **2.2 ç®€å•å…³é”®è¯æå–**
  - å®ç° `extractKeywords()` æ–¹æ³•ï¼ˆä¸è°ƒç”¨ LLMï¼‰
  - ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ç§»é™¤åœç”¨è¯
  - ç›´æ¥ä½¿ç”¨ç”¨æˆ·é—®é¢˜ä½œä¸ºæœç´¢æŸ¥è¯¢

- [ ] **2.3 Firecrawl Search è°ƒç”¨**
  - å®ç° `FirecrawlClient.search()` æ–¹æ³•
  - å¤„ç†ä½ç½®å‚æ•°æ˜ å°„(`user_location` â†’ `location`)
  - å®ç°åŸŸåè¿‡æ»¤é€»è¾‘(åå¤„ç†è¿‡æ»¤ç»“æœ)
  - å¤„ç†é”™è¯¯å’Œé‡è¯•é€»è¾‘

- [ ] **2.4 å“åº”æ ¼å¼è½¬æ¢**
  - å®ç° `convertSearchResult()` æ–¹æ³•
  - ç”Ÿæˆ `encrypted_content` (ä½¿ç”¨ UUID + base64)
  - æ„å»º `web_search_tool_result` ç»“æ„
  - **æš‚ä¸å®ç°** citationsï¼ˆå¯é€‰åŠŸèƒ½ï¼‰

- [ ] **2.5 é›†æˆåˆ°ä¸»æµç¨‹**
  - ä¿®æ”¹ `handle_anthropic_stream.ts`
  - åœ¨æ£€æµ‹åˆ° web_search tool æ—¶è°ƒç”¨æ‹¦æˆªå™¨
  - å°†ç»“æœæ³¨å…¥åˆ°å“åº”æµä¸­
  - **æš‚ä¸å¤„ç†** `pause_turn` åœºæ™¯ï¼ˆåç»­ä¼˜åŒ–ï¼‰

#### éªŒè¯æ ‡å‡†:
- âœ… èƒ½å¤Ÿæ‹¦æˆª web_search è¯·æ±‚å¹¶è°ƒç”¨ Firecrawl
- âœ… å“åº”æ ¼å¼ç¬¦åˆ Anthropic åŸºæœ¬è§„èŒƒï¼ˆåŒ…å« server_tool_use å’Œ web_search_tool_resultï¼‰
- âœ… æœç´¢ç»“æœæ­£ç¡®è¿”å›ï¼ˆURLã€æ ‡é¢˜ã€å†…å®¹ï¼‰
- âš ï¸ æš‚ä¸è¦æ±‚ citations å’Œå¤šè½®å¯¹è¯æ”¯æŒï¼ˆåç»­ä¼˜åŒ–ï¼‰

#### æµ‹è¯•ç”¨ä¾‹:

**æµ‹è¯• 1: åŸºæœ¬æœç´¢ï¼ˆæœ€å°å¯è¡Œï¼‰**
- è¯·æ±‚æ ¼å¼ï¼šåŒ…å« `web_search_20250305` tool çš„æ ‡å‡†æ¶ˆæ¯
- ç”¨æˆ·æ¶ˆæ¯ï¼š"What is Firecrawl?"
- æœŸæœ›å“åº”ï¼š
  - åŒ…å« `server_tool_use` å—ï¼Œname ä¸º "web_search"
  - åŒ…å« `web_search_tool_result` å—ï¼Œå†…å«æœç´¢ç»“æœæ•°ç»„
  - æ¯ä¸ªç»“æœåŒ…å« urlã€titleã€encrypted_contentã€page_age

**æµ‹è¯• 2: å¸¦åŸŸåè¿‡æ»¤çš„æœç´¢ï¼ˆå¯é€‰ï¼‰**
- è¯·æ±‚æ ¼å¼ï¼šåŒæµ‹è¯• 1ï¼Œä½† tool å®šä¹‰ä¸­åŒ…å« `allowed_domains: ["docs.firecrawl.dev"]`
- æœŸæœ›å“åº”ï¼š
  - æœç´¢ç»“æœåªåŒ…å«æŒ‡å®šåŸŸåçš„ URL
  - å…¶ä»–åŸŸåçš„ç»“æœè¢«è¿‡æ»¤æ‰

---

### é˜¶æ®µ 2.5: æ™ºèƒ½æ¨¡å¼å®ç°ï¼ˆå¯é€‰ï¼‰(1-2 å¤©)

**ç›®æ ‡**: å®ç°æ™ºèƒ½æ¨¡å¼ï¼Œæä¾›åŸºäºæœç´¢ç»“æœçš„ LLM åˆ†æ

**å‰ç½®æ¡ä»¶**: é˜¶æ®µ 2 å®Œæˆå¹¶éªŒè¯é€šè¿‡

#### ä»»åŠ¡æ¸…å•:

- [ ] **2.5.1 é…ç½®æ£€æµ‹**
  - è¯»å– `WEB_SEARCH_MODE` ç¯å¢ƒå˜é‡
  - æ ¹æ®é…ç½®é€‰æ‹© simple æˆ– smart æ¨¡å¼

- [ ] **2.5.2 å®ç° handleSmartMode()**
  - è°ƒç”¨ Firecrawl è·å–æœç´¢ç»“æœ
  - æ„å»ºå¢å¼ºä¸Šä¸‹æ–‡ï¼ˆæœç´¢ç»“æœä½œä¸ºä¸Šä¸‹æ–‡ï¼‰
  - è°ƒç”¨ä¸Šæ¸¸ API ç”Ÿæˆåˆ†æ
  - è¿”å›ï¼šæœç´¢ç»“æœ + LLM åˆ†æ

- [ ] **2.5.3 æµå¼å“åº”ä¼˜åŒ–**
  - å…ˆæµå¼è¾“å‡ºæœç´¢ç»“æœ
  - å†æµå¼è¾“å‡º LLM åˆ†æ
  - æ·»åŠ è¿›åº¦æç¤º

#### éªŒè¯æ ‡å‡†:
- âœ… æ™ºèƒ½æ¨¡å¼èƒ½æ­£ç¡®è°ƒç”¨ä¸Šæ¸¸ API
- âœ… è¿”å›åŒ…å«æœç´¢ç»“æœå’Œåˆ†æ
- âœ… æµå¼å“åº”æµç•…

---

### é˜¶æ®µ 3: Web Fetch åŠŸèƒ½å®ç° (2-3 å¤©)

**ç›®æ ‡**: å®ç° Web Fetch å·¥å…·çš„å®Œæ•´æ‹¦æˆªå’Œè½¬æ¢

#### ä»»åŠ¡æ¸…å•:

- [ ] **3.1 è¯·æ±‚æ‹¦æˆª**
  - è¯†åˆ« `web_fetch_20250910` tool
  - æå– URL å’Œå‚æ•°
  - å®ç° URL éªŒè¯é€»è¾‘(æ£€æŸ¥ URL æ˜¯å¦åœ¨å¯¹è¯å†å²ä¸­)

- [ ] **3.2 Firecrawl Scrape è°ƒç”¨**
  - å®ç° `FirecrawlClient.scrape()` æ–¹æ³•
  - å¤„ç† `max_content_tokens` é™åˆ¶
  - å®ç°åŸŸåè¿‡æ»¤
  - å¤„ç† PDF å’Œæ–‡æœ¬å†…å®¹

- [ ] **3.3 å“åº”æ ¼å¼è½¬æ¢**
  - å®ç° `convertScrapeResult()` æ–¹æ³•
  - ç”Ÿæˆ `document` å—ç»“æ„
  - å¤„ç† base64 ç¼–ç (PDF)
  - å®ç°å¯é€‰çš„ citations ç”Ÿæˆ

- [ ] **3.4 ä¸ Web Search è”åŠ¨**
  - ä» Web Search ç»“æœä¸­æå– URL
  - è‡ªåŠ¨å°†è¿™äº› URL åŠ å…¥ Web Fetch ç™½åå•
  - å®ç°è·¨å·¥å…·çš„ä¸Šä¸‹æ–‡ä¼ é€’

- [ ] **3.5 é›†æˆåˆ°ä¸»æµç¨‹**
  - ä¿®æ”¹ä¸»å¤„ç†æµç¨‹,æ·»åŠ  web_fetch æ‹¦æˆª
  - å®ç°æµå¼å“åº”
  - å¤„ç†è¶…æ—¶å’Œé”™è¯¯

#### éªŒè¯æ ‡å‡†:
- èƒ½å¤Ÿæ‹¦æˆª web_fetch è¯·æ±‚å¹¶è°ƒç”¨ Firecrawl
- URL éªŒè¯æ­£ç¡®å·¥ä½œ
- PDF å’Œæ–‡æœ¬å†…å®¹æ­£ç¡®å¤„ç†
- ä¸ web_search è”åŠ¨æ­£å¸¸

#### æµ‹è¯•ç”¨ä¾‹:

**æµ‹è¯• 1: è·å–å•ä¸ª URL**
- è¯·æ±‚æ ¼å¼ï¼šåŒ…å« `web_fetch_20250910` tool çš„æ ‡å‡†æ¶ˆæ¯
- ç”¨æˆ·æ¶ˆæ¯ï¼š"Please analyze https://docs.firecrawl.dev/features/scrape"
- æœŸæœ›å“åº”ï¼š
  - åŒ…å« `server_tool_use` å—ï¼Œname ä¸º "web_fetch"
  - åŒ…å« `web_fetch_tool_result` å—ï¼Œå†…å« document ç±»å‹å†…å®¹
  - document åŒ…å« sourceï¼ˆæ–‡æœ¬æˆ– base64ï¼‰ã€titleã€citations ç­‰

**æµ‹è¯• 2: Search + Fetch ç»„åˆ**
- ç¬¬ä¸€è½®ï¼šæœç´¢ "Firecrawl"ï¼Œè·å–æœç´¢ç»“æœåˆ—è¡¨
- ç¬¬äºŒè½®ï¼šä½¿ç”¨ web_fetch è·å–ç¬¬ä¸€ä¸ªæœç´¢ç»“æœçš„ URL å†…å®¹
- éªŒè¯ï¼šç¬¬äºŒè½®è¯·æ±‚èƒ½æˆåŠŸè·å–å†…å®¹ï¼Œå› ä¸º URL å·²åœ¨ç¬¬ä¸€è½®å‡ºç°

---

### é˜¶æ®µ 4: æµå¼å“åº”ä¼˜åŒ– (1-2 å¤©)

**ç›®æ ‡**: ä¼˜åŒ– SSE æµå¼å“åº”,æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

#### ä»»åŠ¡æ¸…å•:

- [ ] **4.1 è¿›åº¦äº‹ä»¶**
  - åœ¨ Firecrawl è¯·æ±‚æœŸé—´å‘é€è¿›åº¦äº‹ä»¶
  - å®ç° `content_block_start`/`delta`/`stop` äº‹ä»¶åºåˆ—
  - æ·»åŠ ç­‰å¾…æç¤º("Searching...", "Fetching...")

- [ ] **4.2 æµå¼å†…å®¹ä¼ è¾“**
  - å¦‚æœ Firecrawl ç»“æœå¾ˆå¤§,åˆ†å—ä¼ è¾“
  - å®ç° `pause_turn` æœºåˆ¶
  - ä¼˜åŒ–å†…å­˜ä½¿ç”¨

- [ ] **4.3 é”™è¯¯å¤„ç†**
  - åœ¨æµä¸­æ­£ç¡®æŠ¥å‘Šé”™è¯¯
  - å®ç°ä¼˜é›…é™çº§(Firecrawl å¤±è´¥æ—¶çš„å¤„ç†)
  - æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

#### éªŒè¯æ ‡å‡†:
- æµå¼å“åº”æµç•…,æ— å¡é¡¿
- è¿›åº¦æç¤ºæ¸…æ™°
- é”™è¯¯èƒ½è¢«æ­£ç¡®æ•è·å’ŒæŠ¥å‘Š

---

### é˜¶æ®µ 5: æµ‹è¯•ä¸ä¼˜åŒ– (2-3 å¤©)

**ç›®æ ‡**: å…¨é¢æµ‹è¯•åŠŸèƒ½,ä¼˜åŒ–æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ

#### ä»»åŠ¡æ¸…å•:

- [ ] **5.1 å•å…ƒæµ‹è¯•**
  - ä¸ºæ¯ä¸ªæ¨¡å—ç¼–å†™å•å…ƒæµ‹è¯•
  - æµ‹è¯•è¦†ç›–ç‡ > 80%
  - Mock Firecrawl API å“åº”

- [ ] **5.2 é›†æˆæµ‹è¯•**
  - ç«¯åˆ°ç«¯æµ‹è¯• Web Search åŠŸèƒ½
  - ç«¯åˆ°ç«¯æµ‹è¯• Web Fetch åŠŸèƒ½
  - æµ‹è¯• Search + Fetch ç»„åˆåœºæ™¯
  - æµ‹è¯•å¤šè½®å¯¹è¯

- [ ] **5.3 æ€§èƒ½ä¼˜åŒ–**
  - å‡å°‘ä¸å¿…è¦çš„ API è°ƒç”¨
  - ä¼˜åŒ–å†…å­˜ä½¿ç”¨
  - å‹åŠ›æµ‹è¯•

- [ ] **5.4 è¾¹ç¼˜æƒ…å†µå¤„ç†**
  - æµ‹è¯•å„ç§é”™è¯¯åœºæ™¯
  - æµ‹è¯•è¶…å¤§å“åº”
  - æµ‹è¯•å¹¶å‘è¯·æ±‚
  - æµ‹è¯•ç½‘ç»œè¶…æ—¶

- [ ] **5.5 æ–‡æ¡£æ›´æ–°**
  - æ›´æ–° README
  - æ·»åŠ é…ç½®è¯´æ˜
  - æ·»åŠ ä½¿ç”¨ç¤ºä¾‹
  - æ›´æ–° API æ–‡æ¡£

#### éªŒè¯æ ‡å‡†:
- æ‰€æœ‰æµ‹è¯•é€šè¿‡
- æ— å·²çŸ¥ bug
- æ€§èƒ½æ»¡è¶³è¦æ±‚
- æ–‡æ¡£å®Œå–„

---

## å››ã€æŠ€æœ¯å®ç°ç»†èŠ‚

### 4.1 è¯·æ±‚æ‹¦æˆªé€»è¾‘

**å®ç°ä½ç½®**ï¼š`deno-proxy/src/handle_anthropic_stream.ts`

**æ‹¦æˆªæµç¨‹**ï¼š
1. åœ¨æ¥æ”¶åˆ° Anthropic API è¯·æ±‚æ—¶ï¼Œæ£€æŸ¥ `tools` æ•°ç»„
2. è¯†åˆ«æ˜¯å¦åŒ…å« `web_search_20250305` æˆ– `web_fetch_20250910` ç±»å‹çš„ tool
3. å¦‚æœæ£€æµ‹åˆ°éœ€è¦æ‹¦æˆªçš„ toolï¼Œåˆ›å»ºå¯¹åº”çš„æ‹¦æˆªå™¨å®ä¾‹
4. æ ¹æ® tool ç±»å‹è°ƒç”¨ç›¸åº”çš„å¤„ç†æ–¹æ³•ï¼š
   - `web_search_20250305` â†’ WebSearchInterceptor.intercept()
   - `web_fetch_20250910` â†’ WebFetchInterceptor.intercept()
5. è¿”å›æ‹¦æˆªå™¨ç”Ÿæˆçš„ ToolResultï¼Œè€Œä¸æ˜¯è½¬å‘åˆ°ä¸Šæ¸¸ API

**å…³é”®å†³ç­–ç‚¹**ï¼š
- æ£€æŸ¥åŠŸèƒ½å¼€å…³æ˜¯å¦å¯ç”¨ï¼ˆENABLE_WEB_SEARCH_INTERCEPT / ENABLE_WEB_FETCH_INTERCEPTï¼‰
- åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªï¼ˆæ˜¯å¦åŒ…å«ç›®æ ‡ tool ç±»å‹ï¼‰
- é€‰æ‹©ç®€å•æ¨¡å¼æˆ–æ™ºèƒ½æ¨¡å¼ï¼ˆæ ¹æ® WEB_SEARCH_MODE ç¯å¢ƒå˜é‡ï¼‰

### 4.2 æ ¼å¼è½¬æ¢è¯¦è§£

**è½¬æ¢ç›®æ ‡**ï¼šå°† Firecrawl API çš„å“åº”æ ¼å¼è½¬æ¢ä¸ºç¬¦åˆ Anthropic è§„èŒƒçš„æ ¼å¼

**Search Result è½¬æ¢**ï¼š
- **è¾“å…¥**ï¼šFirecrawl è¿”å›çš„æœç´¢ç»“æœï¼ŒåŒ…å« data.web æ•°ç»„ï¼Œæ¯é¡¹æœ‰ urlã€titleã€descriptionã€markdown ç­‰å­—æ®µ
- **å¤„ç†æ­¥éª¤**ï¼š
  1. éå† data.web æ•°ç»„ä¸­çš„æ¯ä¸ªæœç´¢ç»“æœ
  2. ä¸ºæ¯ä¸ªç»“æœç”Ÿæˆå”¯ä¸€çš„åŠ å¯†å†…å®¹æ ‡è¯†ï¼ˆä½¿ç”¨ UUIDï¼‰
  3. å°†æ ‡è¯†å’Œå†…å®¹ä¿¡æ¯æ‰“åŒ…ä¸º JSON å¯¹è±¡
  4. ä½¿ç”¨ base64 ç¼–ç ç”Ÿæˆ encrypted_content
  5. æ„å»º web_search_result å¯¹è±¡ï¼ŒåŒ…å«å¿…è¦å­—æ®µ
- **è¾“å‡º**ï¼šAnthropic æ ¼å¼çš„ web_search_tool_resultï¼ŒåŒ…å«å¤šä¸ª web_search_result é¡¹

**Scrape Result è½¬æ¢**ï¼š
- **è¾“å…¥**ï¼šFirecrawl scrape å“åº”ï¼ŒåŒ…å« data.markdownã€data.htmlã€data.metadata ç­‰
- **å¤„ç†æ­¥éª¤**ï¼š
  1. æå– markdown æˆ– html å†…å®¹
  2. æ„å»º document å¯¹è±¡ï¼Œè®¾ç½® source.type ä¸º "text" æˆ– "base64"
  3. è®¾ç½®æ­£ç¡®çš„ media_typeï¼ˆtext/plain æˆ– application/pdfï¼‰
  4. ä» metadata ä¸­æå– title å’Œå…¶ä»–å…ƒä¿¡æ¯
  5. æ·»åŠ  retrieved_at æ—¶é—´æˆ³
- **è¾“å‡º**ï¼šAnthropic æ ¼å¼çš„ web_fetch_tool_result

**å¼•ç”¨ä¿¡æ¯æ„å»º**ï¼š
- ä»æœç´¢ç»“æœå†…å®¹ä¸­æå–å…³é”®æ–‡æœ¬ç‰‡æ®µï¼ˆå‰ 150 å­—ç¬¦ï¼‰
- ä¸ºæ¯ä¸ªç‰‡æ®µç”Ÿæˆ encrypted_index
- æ„å»º web_search_result_location å¯¹è±¡ï¼ŒåŒ…å« urlã€titleã€cited_text
- è¿”å› Citation æ•°ç»„

### 4.3 SSE æµå¼è¾“å‡ºå¤„ç†

**æµå¼å“åº”ç›®æ ‡**ï¼šæŒ‰ç…§ Anthropic SSE è§„èŒƒï¼Œé€æ­¥å‘é€å“åº”å†…å®¹

**äº‹ä»¶åºåˆ—**ï¼š
1. **message_start**ï¼šå‘é€æ¶ˆæ¯å¼€å§‹äº‹ä»¶
2. **content_block_start**ï¼šå¼€å§‹å‘é€ server_tool_use å—
   - è®¾ç½® type ä¸º "server_tool_use"
   - è®¾ç½® name ä¸º "web_search" æˆ– "web_fetch"
   - åˆ†é…å”¯ä¸€çš„ tool use id
3. **content_block_delta**ï¼šå‘é€ tool è¾“å…¥å‚æ•°
   - type ä¸º "input_json_delta"
   - åŒ…å« partial_json å­—æ®µï¼ˆæŸ¥è¯¢è¯æˆ– URLï¼‰
4. **content_block_stop**ï¼šç»“æŸ tool use å—
5. **è¿›åº¦æç¤º**ï¼ˆå¯é€‰ï¼‰ï¼š
   - å‘é€ text ç±»å‹çš„ content_block
   - å†…å®¹ä¸º "Searching the web..." æˆ– "Fetching content..."
6. **å®é™…ç»“æœå‘é€**ï¼š
   - content_block_startï¼šå¼€å§‹å‘é€ tool_result å—
   - content_block_deltaï¼šé€æ­¥å‘é€æœç´¢ç»“æœæˆ–æŠ“å–å†…å®¹
   - content_block_stopï¼šç»“æŸ tool_result å—
7. **message_delta**ï¼šå‘é€ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯
8. **message_stop**ï¼šæ¶ˆæ¯ç»“æŸ

**å¤§å†…å®¹å¤„ç†**ï¼š
- å¦‚æœ Firecrawl è¿”å›çš„å†…å®¹å¾ˆå¤§ï¼ˆè¶…è¿‡ 10KBï¼‰ï¼Œåˆ†å—ä¼ è¾“
- ä½¿ç”¨å¤šä¸ª content_block_delta äº‹ä»¶é€æ­¥å‘é€
- å®ç° pause_turn æœºåˆ¶ï¼Œå…è®¸å®¢æˆ·ç«¯æš‚åœå’Œç»§ç»­

**é”™è¯¯æµå¼å¤„ç†**ï¼š
- åœ¨æµä¸­å‘é€ error ç±»å‹çš„äº‹ä»¶
- åŒ…å« error_code å’Œ error_message
- ä¼˜é›…å…³é—­æµè¿æ¥

---

## äº”ã€é…ç½®ç®¡ç†

### 5.1 ç¯å¢ƒå˜é‡

**Firecrawl API é…ç½®**ï¼š
- `FIRECRAWL_API_KEY`: Firecrawl API å¯†é’¥ï¼ˆå¿…å¡«ï¼‰
- `FIRECRAWL_BASE_URL`: Firecrawl API åŸºç¡€ URLï¼ˆé»˜è®¤ï¼šhttps://api.firecrawl.dev/v2ï¼‰

**åŠŸèƒ½å¼€å…³**ï¼š
- `ENABLE_WEB_SEARCH_INTERCEPT`: æ˜¯å¦å¯ç”¨ Web Search æ‹¦æˆªï¼ˆtrue/falseï¼Œé»˜è®¤ï¼šfalseï¼‰
- `ENABLE_WEB_FETCH_INTERCEPT`: æ˜¯å¦å¯ç”¨ Web Fetch æ‹¦æˆªï¼ˆtrue/falseï¼Œé»˜è®¤ï¼šfalseï¼‰

**å·¥ä½œæ¨¡å¼é…ç½®**ï¼š
- `WEB_SEARCH_MODE`: Web Search å·¥ä½œæ¨¡å¼
  - `simple`ï¼ˆé»˜è®¤ï¼‰ï¼šåªè¿”å›æœç´¢ç»“æœï¼Œä¸ç”Ÿæˆæ™ºèƒ½å›ç­”
  - `smart`ï¼šè¿”å›æœç´¢ç»“æœ + LLM æ™ºèƒ½åˆ†æï¼ˆéœ€äºŒæ¬¡è¯·æ±‚ï¼‰
- `WEB_FETCH_MODE`: Web Fetch å·¥ä½œæ¨¡å¼
  - `simple`ï¼ˆé»˜è®¤ï¼‰ï¼šåªè¿”å›æŠ“å–å†…å®¹
  - `smart`ï¼šè¿”å›å†…å®¹ + LLM åˆ†æï¼ˆéœ€äºŒæ¬¡è¯·æ±‚ï¼‰

**æ€§èƒ½é…ç½®**ï¼š
- `FIRECRAWL_TIMEOUT`: Firecrawl API è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼Œé»˜è®¤ï¼š30000 å³ 30 ç§’ï¼‰
- `FIRECRAWL_MAX_RETRIES`: æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ï¼š3ï¼‰
- `FIRECRAWL_RETRY_DELAY`: é‡è¯•å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼Œé»˜è®¤ï¼š1000 å³ 1 ç§’ï¼‰

**é™åˆ¶é…ç½®**ï¼š
- `MAX_SEARCH_RESULTS`: æœ€å¤§æœç´¢ç»“æœæ•°é‡ï¼ˆé»˜è®¤ï¼š10ï¼‰
- `MAX_FETCH_CONTENT_TOKENS`: Web Fetch å†…å®¹æœ€å¤§ token æ•°ï¼ˆè¿‘ä¼¼å€¼ï¼Œé»˜è®¤ï¼š100000ï¼‰

### 5.2 é…ç½®æ–‡ä»¶æ›´æ–°

**æ–‡ä»¶ä½ç½®**ï¼š`deno-proxy/src/config.ts`

**éœ€è¦æ·»åŠ çš„é…ç½®ç»“æ„**ï¼š

**FirecrawlConfig æ¥å£**ï¼š
- apiKey: string - API å¯†é’¥
- baseUrl: string - API åŸºç¡€ URL
- timeout: number - è¯·æ±‚è¶…æ—¶æ—¶é—´
- maxRetries: number - æœ€å¤§é‡è¯•æ¬¡æ•°
- retryDelay: number - é‡è¯•å»¶è¿Ÿ

**WebToolsConfig æ¥å£**ï¼š
- enableSearchIntercept: boolean - æ˜¯å¦å¯ç”¨æœç´¢æ‹¦æˆª
- enableFetchIntercept: boolean - æ˜¯å¦å¯ç”¨æŠ“å–æ‹¦æˆª
- searchMode: 'simple' | 'smart' - æœç´¢å·¥ä½œæ¨¡å¼
- fetchMode: 'simple' | 'smart' - æŠ“å–å·¥ä½œæ¨¡å¼
- limits é…ç½®ï¼š
  - maxSearchResults: number - æœ€å¤§æœç´¢ç»“æœæ•°
  - maxFetchContentTokens: number - æœ€å¤§å†…å®¹ token æ•°

**é…ç½®å¯¼å‡º**ï¼š
- ä»ç¯å¢ƒå˜é‡è¯»å–é…ç½®å€¼
- æä¾›åˆç†çš„é»˜è®¤å€¼
- å¯¼å‡º config å¯¹è±¡ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨

---

## å…­ã€æµ‹è¯•ç­–ç•¥

### 6.1 å•å…ƒæµ‹è¯•

**æµ‹è¯•æ–‡ä»¶ä½ç½®**ï¼š`deno-proxy/tests/`

**format_converter_test.ts - æ ¼å¼è½¬æ¢å™¨æµ‹è¯•**ï¼š
- æµ‹è¯• `convertSearchResult()` æ–¹æ³•
  - è¾“å…¥ï¼šæ¨¡æ‹Ÿçš„ Firecrawl æœç´¢ç»“æœ
  - éªŒè¯ï¼šè½¬æ¢åçš„ç»“æœç±»å‹ä¸º `web_search_tool_result`
  - éªŒè¯ï¼štool_use_id æ­£ç¡®è®¾ç½®
  - éªŒè¯ï¼šcontent æ•°ç»„é•¿åº¦æ­£ç¡®
  - éªŒè¯ï¼šæ¯ä¸ªç»“æœåŒ…å« urlã€titleã€encrypted_content

- æµ‹è¯• `convertScrapeResult()` æ–¹æ³•
  - è¾“å…¥ï¼šæ¨¡æ‹Ÿçš„ Firecrawl æŠ“å–ç»“æœ
  - éªŒè¯ï¼šè½¬æ¢åçš„ç»“æœç±»å‹ä¸º `web_fetch_tool_result`
  - éªŒè¯ï¼šdocument ç»“æ„æ­£ç¡®
  - éªŒè¯ï¼šsource å­—æ®µåŒ…å«æ­£ç¡®çš„ media_type å’Œ data

- æµ‹è¯• `buildCitations()` æ–¹æ³•
  - è¾“å…¥ï¼šæ–‡æœ¬å†…å®¹å’Œæ¥æºä¿¡æ¯
  - éªŒè¯ï¼šè¿”å›çš„ citations æ•°ç»„ç»“æ„æ­£ç¡®
  - éªŒè¯ï¼šæ¯ä¸ª citation åŒ…å«å¿…è¦å­—æ®µ

**firecrawl_client_test.ts - Firecrawl å®¢æˆ·ç«¯æµ‹è¯•**ï¼š
- Mock Firecrawl API å“åº”
- æµ‹è¯• search() æ–¹æ³•çš„å‚æ•°ä¼ é€’
- æµ‹è¯• scrape() æ–¹æ³•çš„é”™è¯¯å¤„ç†
- æµ‹è¯•é‡è¯•é€»è¾‘

### 6.2 é›†æˆæµ‹è¯•

**web_search_integration_test.ts - Web Search ç«¯åˆ°ç«¯æµ‹è¯•**ï¼š

**æµ‹è¯•åœºæ™¯ 1ï¼šåŸºæœ¬æœç´¢æµç¨‹**
- åˆ›å»ºåŒ…å« `web_search_20250305` tool çš„æ¨¡æ‹Ÿè¯·æ±‚
- ç”¨æˆ·æ¶ˆæ¯ï¼š"What is Firecrawl?"
- å‘é€ POST è¯·æ±‚åˆ° `/v1/messages` ç«¯ç‚¹
- éªŒè¯ HTTP å“åº”çŠ¶æ€ç ä¸º 200
- è§£æ SSE æµå¼å“åº”
- éªŒè¯å“åº”åŒ…å« `content_block_start` äº‹ä»¶ï¼Œç±»å‹ä¸º `server_tool_use`
- éªŒè¯å“åº”åŒ…å« `web_search_tool_result` å—
- éªŒè¯æœç´¢ç»“æœåŒ…å« URLã€æ ‡é¢˜å’ŒåŠ å¯†å†…å®¹

**æµ‹è¯•åœºæ™¯ 2ï¼šåŸŸåè¿‡æ»¤**
- åˆ›å»ºå¸¦ `allowed_domains` å‚æ•°çš„è¯·æ±‚
- éªŒè¯è¿”å›çš„æœç´¢ç»“æœåªåŒ…å«å…è®¸çš„åŸŸå
- éªŒè¯è¢«é˜»æ­¢åŸŸåçš„ç»“æœå·²è¢«è¿‡æ»¤

**web_fetch_integration_test.ts - Web Fetch ç«¯åˆ°ç«¯æµ‹è¯•**ï¼š

**æµ‹è¯•åœºæ™¯ 1ï¼šæŠ“å–å•ä¸ª URL**
- åˆ›å»ºåŒ…å« `web_fetch_20250910` tool çš„è¯·æ±‚
- æŒ‡å®šä¸€ä¸ªæœ‰æ•ˆçš„ URL
- éªŒè¯è¿”å›çš„ document åŒ…å«å†…å®¹
- éªŒè¯ retrieved_at æ—¶é—´æˆ³å­˜åœ¨

**æµ‹è¯•åœºæ™¯ 2ï¼šSearch + Fetch ç»„åˆ**
- ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼šä½¿ç”¨ web_search
- ç¬¬äºŒæ¬¡è¯·æ±‚ï¼šä½¿ç”¨ web_fetch è·å–ç¬¬ä¸€æ¬¡æœç´¢ç»“æœä¸­çš„ URL
- éªŒè¯ç¬¬äºŒæ¬¡è¯·æ±‚æˆåŠŸï¼ˆURL åœ¨å¯¹è¯å†å²ä¸­ï¼‰

**æµ‹è¯•åœºæ™¯ 3ï¼šPDF å¤„ç†**
- æä¾›ä¸€ä¸ª PDF æ–‡ä»¶çš„ URL
- éªŒè¯è¿”å›çš„ media_type ä¸º "application/pdf"
- éªŒè¯ source.type ä¸º "base64"
- éªŒè¯ data å­—æ®µåŒ…å« base64 ç¼–ç å†…å®¹

### 6.3 æ€§èƒ½æµ‹è¯•

**performance_test.ts - è´Ÿè½½æµ‹è¯•**ï¼š

**å¹¶å‘æœç´¢æµ‹è¯•**ï¼š
- åŒæ—¶å‘é€ 10 ä¸ªæœç´¢è¯·æ±‚
- æµ‹é‡å¼€å§‹å’Œç»“æŸæ—¶é—´
- éªŒè¯æ‰€æœ‰è¯·æ±‚éƒ½æˆåŠŸè¿”å›
- è®¡ç®—å¹³å‡å“åº”æ—¶é—´
- æ–­è¨€å¹³å‡å“åº”æ—¶é—´ < 5 ç§’

**å†…å­˜ä½¿ç”¨æµ‹è¯•**ï¼š
- è¿ç»­æ‰§è¡Œ 1000 æ¬¡æœç´¢
- ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
- éªŒè¯æ²¡æœ‰æ˜æ˜¾çš„å†…å­˜æ³„æ¼

---


### 7.2 æ—¥å¿—è®¾è®¡

**æ—¥å¿—çº§åˆ«**ï¼šINFOã€WARNã€ERROR

**æœç´¢å¼€å§‹æ—¥å¿—**ï¼ˆINFOï¼‰ï¼š
- äº‹ä»¶ï¼š"Web search intercepted"
- åŒ…å«å­—æ®µï¼š
  - toolUseIdï¼šå·¥å…·ä½¿ç”¨ ID
  - queryï¼šç”¨æˆ·æŸ¥è¯¢è¯
  - maxUsesï¼šæœ€å¤§ä½¿ç”¨æ¬¡æ•°
  - domainsï¼šå…è®¸/é˜»æ­¢çš„åŸŸååˆ—è¡¨
  - modeï¼šå·¥ä½œæ¨¡å¼ï¼ˆsimple/smartï¼‰

**Firecrawl API è°ƒç”¨æ—¥å¿—**ï¼ˆINFOï¼‰ï¼š
- äº‹ä»¶ï¼š"Calling Firecrawl Search API" æˆ– "Calling Firecrawl Scrape API"
- åŒ…å«å­—æ®µï¼š
  - query/urlï¼šæŸ¥è¯¢è¯æˆ– URL
  - limitï¼šç»“æœæ•°é‡é™åˆ¶
  - locationï¼šåœ°ç†ä½ç½®
  - timeoutï¼šè¶…æ—¶è®¾ç½®

**Firecrawl API å“åº”æ—¥å¿—**ï¼ˆINFOï¼‰ï¼š
- äº‹ä»¶ï¼š"Firecrawl Search completed" æˆ– "Firecrawl Scrape completed"
- åŒ…å«å­—æ®µï¼š
  - resultsCountï¼šè¿”å›ç»“æœæ•°é‡
  - durationï¼šè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  - creditsUsedï¼šæ¶ˆè€—çš„ credits
  - statusCodeï¼šHTTP çŠ¶æ€ç 

**æ ¼å¼è½¬æ¢æ—¥å¿—**ï¼ˆINFOï¼‰ï¼š
- äº‹ä»¶ï¼š"Converting search results" æˆ– "Converting scrape result"
- åŒ…å«å­—æ®µï¼š
  - inputFormatï¼šè¾“å…¥æ ¼å¼ï¼ˆfirecrawlï¼‰
  - outputFormatï¼šè¾“å‡ºæ ¼å¼ï¼ˆanthropicï¼‰
  - resultsCountï¼šè½¬æ¢çš„ç»“æœæ•°é‡
  - durationï¼šè½¬æ¢è€—æ—¶

**é”™è¯¯æ—¥å¿—**ï¼ˆERRORï¼‰ï¼š
- äº‹ä»¶ï¼š"Firecrawl API error" æˆ– "Format conversion error"
- åŒ…å«å­—æ®µï¼š
  - errorï¼šé”™è¯¯æ¶ˆæ¯
  - statusCodeï¼šHTTP çŠ¶æ€ç ï¼ˆå¦‚é€‚ç”¨ï¼‰
  - retryAfterï¼šé‡è¯•å»¶è¿Ÿï¼ˆå¦‚é€‚ç”¨ï¼‰
  - stackï¼šé”™è¯¯å †æ ˆè·Ÿè¸ª
  - contextï¼šé”™è¯¯ä¸Šä¸‹æ–‡ä¿¡æ¯

**è­¦å‘Šæ—¥å¿—**ï¼ˆWARNï¼‰ï¼š
- Firecrawl API å“åº”æ…¢ï¼ˆ> 5 ç§’ï¼‰
- é‡è¯•æ¬¡æ•°è¾¾åˆ°ä¸Šé™
- æœç´¢ç»“æœä¸ºç©º

### 7.3 ç›‘æ§ä»ªè¡¨æ¿å»ºè®®

**å®æ—¶ç›‘æ§é¢æ¿**ï¼š
1. è¯·æ±‚é‡è¶‹åŠ¿å›¾ï¼ˆæŒ‰åˆ†é’Ÿ/å°æ—¶ï¼‰
2. å¹³å‡å“åº”æ—¶é—´è¶‹åŠ¿å›¾
3. é”™è¯¯ç‡è¶‹åŠ¿å›¾
4. å½“å‰å¹¶å‘è¯·æ±‚æ•°

**å‘Šè­¦è§„åˆ™**ï¼š
1. Firecrawl API é”™è¯¯ç‡ > 10%ï¼ˆ5 åˆ†é’Ÿå†…ï¼‰
2. å¹³å‡å“åº”æ—¶é—´ > 10 ç§’ï¼ˆ5 åˆ†é’Ÿå†…ï¼‰
3. å†…å­˜ä½¿ç”¨ç‡ > 90%
4. Firecrawl API è°ƒç”¨è¢«é™æµï¼ˆ429 é”™è¯¯ï¼‰

**æ—¥å¿—èšåˆ**ï¼š
- å»ºè®®ä½¿ç”¨æ—¥å¿—èšåˆå·¥å…·ï¼ˆå¦‚ ELKã€Loki ç­‰ï¼‰
- æŒ‰é”™è¯¯ç±»å‹åˆ†ç»„ç»Ÿè®¡
- æŒ‰æ—¶é—´æ®µåˆ†æè¶‹åŠ¿
- æ”¯æŒå¿«é€Ÿæœç´¢å’Œè¿‡æ»¤


---

## é™„å½•

### A. ç›¸å…³æ–‡æ¡£

- [æŠ€æœ¯èµ„æ–™æ–‡æ¡£](./web-search-fetch-integration-research.md)
- [Anthropic Web Search Tool å®˜æ–¹æ–‡æ¡£](https://platform.claude.com/docs/en/agents-and-tools/tool-use/web-search-tool)
- [Anthropic Web Fetch Tool å®˜æ–¹æ–‡æ¡£](https://platform.claude.com/docs/en/agents-and-tools/tool-use/web-fetch-tool)
- [Firecrawl Search API å®˜æ–¹æ–‡æ¡£](https://docs.firecrawl.dev/features/search)
- [Firecrawl Scrape API å®˜æ–¹æ–‡æ¡£](https://docs.firecrawl.dev/features/scrape)

### C. è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®,è¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»:
- GitHub Issues: https://github.com/Passerby1011/cc-proxy/issues
- é‚®ä»¶: [é¡¹ç›®ç»´æŠ¤è€…é‚®ç®±]
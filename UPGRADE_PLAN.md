# CC-PROXY 项目升级技术实现方案

> **升级日期**: 2026-01-04
> **目标**: 为项目添加 Web UI 管理界面，支持本地和远程 PostgreSQL 配置存储
> **发布计划**: 当前版本将首先推送到 `development` 分支进行测试验证。

---

## 📊 项目现状分析

### 当前架构
- **技术栈**: Deno + TypeScript
- **配置方式**: 纯环境变量（25+ 个配置项）
- **核心功能**: AI API 代理服务，支持多渠道路由、工具调用模拟、Token 计数

---

## 🎯 升级目标

1. **Web UI 管理界面** - 深色奢华极简风格的可视化配置管理。
2. **灵活存储方案** - 支持本地 JSON 文件或 PostgreSQL 数据库（二选一）。
3. **一体化架构** - 管理界面与代理服务共用端口，路径分离。
4. **向后兼容** - 保持环境变量配置方式。

---

## 🏗️ 技术架构设计

### 整体架构
- **服务融合**: 管理界面 (UI) 与代理 API 运行在同一端口。
  - `/` 或 `/admin`: 管理界面入口。
  - `/api/admin/*`: 管理端 REST 接口。
  - `/v1/*`: 代理 API 接口。
- **Web UI**: 单页应用 (SPA)，使用 Preact + HTM (无构建)。
- **ConfigService**: 配置服务层，支持内存缓存、手动同步和持久化。
- **Storage Layer**: 抽象存储层，支持本地文件系统和 PostgreSQL。

---

## 📁 核心模块实现框架

### 1. 存储抽象层 (Storage Layer)
- 定义 `ConfigStorage` 接口：加载、保存、健康检查。
- 实现 `LocalStorage` 与 `PostgresStorage`。
- **模式切换**: 系统根据环境变量配置，在启动时自动选择并初始化其中一种存储实现（互斥关系）。

### 2. 配置服务层 (Configuration Service)
- **启动加载**: 启动时从存储（文件或数据库）拉取配置到内存。
- **干扰排除**: 采用“配置项白名单”机制，仅识别和合并预定义的业务环境变量，忽略系统中其他无关的环境变量。
- **配置合并**: 环境变量优先级最高，覆盖存储中的相同配置项。
- **持久化**: 网页端修改后即时写入存储。
- **手动同步**: 增加“从数据库重载”功能，允许手动强制刷新内存配置。

### 3. Admin API
- 实现基于 JWT 或 Simple Key 的身份验证。
- 路径与代理逻辑分离，互不干扰。

### 4. Web UI 前端 (深色奢华极简主义)
- **视觉氛围**:
  - 纯黑背景 (`#000000`) 与深灰渐变。
  - 表面使用半透明白色叠加 (`rgba(255,255,255,0.05)`)。
  - 极致的负空间感，拒绝拥挤。
- **排版与形状**:
  - 大标题 (24-32px, 700)，正文 (14-16px)，次要信息 (12px, 300)。
  - 统一 8-12px 中等圆角，极细边框 (0.5px)。
- **交互**:
  - 柔和的灰阶过渡。
  - 仅使用线性均匀笔触的图标 (Lucide)。
  - 毛玻璃效果与微妙阴影。

---

## 🔧 环境变量配置
- `PGSTORE_DSN`: PostgreSQL 连接字符串。
- `CONFIG_FILE_PATH`: 本地存储路径。
- `ADMIN_API_KEY`: 管理员访问密钥。

---

## 📊 存储逻辑简化
- **单实例设计**: 一个项目对应一个数据库，不进行多实例自动同步。
- **读写策略**:
  - **读**: 仅在服务启动时或用户点击“手动同步”时读取。
  - **写**: 仅在 Web UI 修改配置提交时触发写入。

---

## 🔒 安全实现
- 管理接口需通过 `ADMIN_API_KEY` 验证。
- 敏感配置（如 API Key）建议支持加密存储逻辑。

---

## 🔄 操作流程
- **启动**: 检查环境 -> 读取存储 -> 合并环境变量 -> 启动服务。
- **管理**: 访问后台路径 -> 身份验证 -> 修改配置 -> 保存到存储并即时更新内存。
- **同步**: 必要时点击“同步”按钮，强制从数据库重新读取配置覆盖内存。

---

**文档版本**: v2.1
**最后更新**: 2026-01-04
